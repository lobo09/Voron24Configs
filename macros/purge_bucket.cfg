[gcode_macro PURGE_BUCKET]
gcode:
  {% set purge = params.PURGE|default(10.0)|float %}
  {% set purge_speed = params.PURGE_SPEED|default(300)|float %}
  {% set retract = params.RETRACT|default(0.4)|float %}
  {% set retract_speed = params.RETRACT_SPEED|default(2400)|float %}
  {% set z_pos = printer.toolhead.position.z %}

  SAVE_GCODE_STATE NAME=PURGE_BUCKET
  
  G90                                      ; absolute
  G92 E0                                   ; reset extruder pos
  G0 X290 Y300  F9000                      ; go to purge bucket
  G0 Z10 F600                              ; lower above purge bucket
  G0 E{purge} F{purge_speed}               ; purge
  G0 X250 Y300 F3000 Z3                    ; move to brush
  G0 X200 Y300 F6000                       ; move across brush
  G0 E-{retract} F{retract_speed}          ; Retract a little
  G0 X250  F18000                          ; return across brush
  G0 X200  F18000                          ; return across brush
  G0 X250  F18000                          ; return across brush
  G0 Z{z_pos} F600                         ; Raise to previous z 
  M400                                     ; wait until all moves are finished

  RESTORE_GCODE_STATE NAME=PURGE_BUCKET