[gcode_macro M191]
gcode:
    {% set S = params.S|default(0) %}
    {% set R = params.R|default(120) %}
    {% set center_x = printer.toolhead.axis_maximum.x / 2 | float %}              # Create center point of x
    {% set center_y = printer.toolhead.axis_maximum.y / 2 | float %}              # Create center point of y

    SAVE_GCODE_STATE NAME=M191_state
    
    SET_DISPLAY_TEXT MSG="heating chamber to {S}C"
    RESPOND MSG="heating chamber to {S}C"
    #NEVERMORE_ON
    #M140 S100                                                                    # turn on bed heating
    SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={S}               # set chamber fan to chamber temp

    CG28                                                                          # (conditional) Full home (XYZ)
    G90                                                                           # absolute mode
    G0 X{center_x} Y{center_y} Z10 F9000                                          # move to center of the bed
    M104 S130                                                                     # heat extruder to help
    M106 S255                                                                     # turn on part cooling fan to circulate the air
    NEVERMORE_ON SPEED=0.5                                                        # turn on nevermore to 50% to preheat the chamber
    M190 S100                                                                     # wait for bed heating
    NEVERMORE_ON                                                                  # turn on nevermore to heat the chamber
    
    TEMPERATURE_WAIT SENSOR="temperature_fan chamber" MINIMUM={S} MAXIMUM={R}     # wait until chamber reaches temperature
    M140 S0                                                                       # turn off bed heating
    NEVERMORE_OFF                                                                 # turn off nevermore
    RESPOND MSG="heating chamber done!"
    
    RESTORE_GCODE_STATE NAME=M191_state